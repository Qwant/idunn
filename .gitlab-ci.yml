before_script:
  - source ci/bootstrap.sh

.values:
  - &docker_host            "tcp://manager.maps.qwant.infra:2376"
  - &environment            "$CI_COMMIT_REF_SLUG"
  - &product_ref_slug       "$CI_PRODUCT_SLUG-$CI_COMMIT_REF_SLUG"

.script:
  - &docker_build   docker-compose build --pull
  - &docker_login   docker login --username $CI_REGISTRY_USER --password-stdin $CI_REGISTRY <<< $CI_REGISTRY_PASSWORD
  - &docker_push    docker-compose push
  - &docker_deploy  docker stack deploy --compose-file docker-compose.yml --with-registry-auth "$STACK"

.docker: &docker
  image: registry.qwant.ninja/docker/dood:18.03
  tags:
  - light-docker

.action: &action
  allow_failure: true
  when: manual

push redis image:
  <<: *action
  stage: deploy
  variables:
      COMPOSE_FILE: "docker-compose.build.yml"
      COMPOSE_PROJECT_NAME: *product_ref_slug
  script:
  - *docker_build
  - *docker_login
  - *docker_push
  tags:
  - light

deploy services:
  <<: [*docker, *action]
  stage: deploy
  environment:
    name: *environment
    url: "https://www.qwant.com/maps"
  variables:
    DOCKER_HOST: *docker_host
    DOCKER_TLS_VERIFY: "1"
    STACK: *product_ref_slug
  script:
  - *docker_login
  - *docker_deploy
  - docker service update --network-add ${STACK}_default ${STACK}_traefik || true
  - sleep 10m
