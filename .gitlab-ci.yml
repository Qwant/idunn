stages:
  - build
  - configure
  - development
  - prelive
  - production

variables:
  GIT_SUBMODULE_STRATEGY: recursive

before_script:
  - source ci/bootstrap.sh
  - docker login
    --username "$CI_REGISTRY_USER"
    --password-stdin "$CI_REGISTRY" <<< "$CI_REGISTRY_PASSWORD"


push docker-service-network image:
  stage: build
  tags:
    - light
  script:
    - docker pull "$SOURCE_IMAGE"
    - docker tag "$SOURCE_IMAGE" "$DEST_IMAGE"
    - docker push "$DEST_IMAGE"
  variables:
    SOURCE_IMAGE: "${CI_REGISTRY}/continuous-integration/docker-service-network:3a735904"
    DEST_IMAGE: "${CI_REGISTRY_IMAGE}/ci/docker-service-network:latest"
  when: manual


build:
  stage: build
  tags:
    - light
  script:
    - export REDIS_IMAGE_TAG="$(echo $CI_COMMIT_REF_SLUG | sed 's/master/latest/g')"
    - docker-compose build --pull
    - docker-compose push
    - subst < ci/templates/docker-content-digest.env | tee docker-content-digest.env
  variables:
    COMPOSE_FILE: "docker-compose.build.yml"
    COMPOSE_PROJECT_NAME: "$CI_PROJECT_PATH_SLUG-j$CI_JOB_ID"
    IDUNN_IMAGE_TAG: "latest"
  artifacts:
    paths:
      - docker-content-digest.env
      - ci/bootstrap.sh
      - ci/bin/docker-stack-wait
      - ci/bin/docker-service-network
      - ci/development/docker-compose.yml
      - ci/prelive/docker-compose.yml
      - ci/production/docker-compose.yml
      - docker-compose.yml

build classifier:
  stage: build
  variables:
    DOCKER_CONFIG: "$CI_PROJECT_DIR/.docker"
    TARGET_IMAGE: "$CI_REGISTRY_IMAGE/classifier/maps:1"
    SOURCE_IMAGE: "$CI_REGISTRY/product/nlp/katanoisi/maps:qmaps-1984"
  script:
    - docker pull "$SOURCE_IMAGE"
    - docker tag "$SOURCE_IMAGE" "$TARGET_IMAGE"
    - docker push "$TARGET_IMAGE"
  tags:
    - edge
    - shell

configure:
  stage: configure
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
  before_script:
    - source ci/bootstrap.sh
  script:
    - configure-values ci/values/
  artifacts:
    paths:
      - ci/
      - docker-compose.yml
      - docker-content-digest.env
  dependencies:
    - build
  tags:
    - light

.deploy:
  image: registry.qwant.ninja/docker/dood:18.09
  before_script:
    - source ci/bootstrap.sh
    - docker login 
      --username "$CI_DEPLOY_USER" 
      --password-stdin "$CI_REGISTRY" <<< "$CI_DEPLOY_PASSWORD"
  dependencies:
    - configure
  tags:
    - light-docker
  variables:
    COMPOSE_FILE: "docker-compose.yml:ci/${CI_JOB_STAGE}/docker-compose.yml"
    COMPOSE_PROJECT_NAME: "$CI_PROJECT_PATH_SLUG-j$CI_JOB_ID"
    DOCKER_HOST: "tcp://10.100.31.132:2375"
    GIT_STRATEGY: none
    PROMETHEUS_SERVICE_NAME: "1120_prometheus"
    ROUTER_SERVICE_NAME: "product-maps-traefik_traefik"
    STACK_NAME: "$CI_PROJECT_ID"
  when: manual

.deploy-kube:
  image: registry.qwant.ninja/docker/kubectl:master
  tags:
    - light-docker
  before_script:
    - source ci/bootstrap.sh
    - helm registry login
      --username "$CI_REGISTRY_USER"
      --password-stdin "$CI_REGISTRY" <<< "$CI_REGISTRY_PASSWORD"
  script:
    - kubeconfig
    - helm chart pull "$HELM_CHART_REF"
    - helm chart export "$HELM_CHART_REF" -d ci/
    - helm-deploy
  variables:
    HELM_EXPERIMENTAL_OCI: 1
    HELM_VALUE_FILES: "ci/values/$COMPONENT_NAME/common.yaml:ci/values/$COMPONENT_NAME/$CI_JOB_STAGE.yaml"
    HELM_CHART_REF: "$CI_REGISTRY/helm/text-classifier@sha256:5976865357088765a040027b3ad15116070f891302f2df9d0fa9550808e7d3bd"
    COMPONENT_NAME: classifier
    HELM_RELEASE: "classifier"
    HELM_CHART: "ci/text-classifier"
  resource_group: $CI_PROJECT_ID:$CI_ENVIRONMENT_SLUG
  when: manual

deploy development:
  extends: .deploy
  stage: development
  environment:
    name: "development/idunn"
    url: "http://maps.dev.qwant.ninja/maps"
  script:
    - deploy
  variables:
    KUZZLE_SERVICE_NAME: "1216_kuzzle"
    NLU_SERVICE_NAME: "1701_nlu"

deploy classifier development:
  extends: .deploy-kube
  stage: development
  environment:
    name: "development/classifier"
  variables:
    KUBE_ENV: development

deploy prelive:
  extends: "deploy development"
  stage: prelive
  environment:
    name: "prelive/idunn"
    url: "https://www.qwant.plive/maps"
  variables:
    DOCKER_HOST: "tcp://10.103.9.1:2375"

deploy classifier prelive:
  extends: .deploy-kube
  stage: prelive
  environment:
    name: "prelive/classifier"
  variables:
    KUBE_ENV: integration

deploy production:
  extends: "deploy prelive"
  stage: production
  script:
    - echo "10.100.56.249 manager.maps.qwant.infra" > /etc/hosts
    - deploy
  environment:
    name: production
    url: "https://www.qwant.com/maps"
  variables:
    DOCKER_HOST: "tcp://manager.maps.qwant.infra:2376"
    DOCKER_TLS_VERIFY: "1"
    ROUTER_SERVICE_NAME: "product-maps-production_traefik"

deploy classifier production:
  extends: .deploy-kube
  stage: production
  environment:
    name: "production/classifier"
  variables:
    KUBE_ENV: production
