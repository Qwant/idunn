#!/bin/bash
set -ueo pipefail
set -x

# -----------------------------------------------------------------------------
# Request the Docker Hub registry for the content digest of an image
# -----------------------------------------------------------------------------
# usage: docker-content-digest <qwant|docker> <image> <tag>

function auth
{
    curl_args=(--header "Content-Type: application/json" --location --show-error --silent)

    if [ $service == "qwant" ]; then
        curl_args+=(--user "$CI_REGISTRY_USER:$CI_REGISTRY_PASSWORD")
    fi

    curl -m 2 "$auth_service&scope=repository:$image:$tag,pull" "${curl_args[@]}" | jq -r '.token'
}

function digest # <image> <tag>
{
    local image="$1"
    local tag="$2"

    curl -m 2 "https://$registry_url/v2/$image/manifests/$tag" \
         --head \
         --header "Accept: application/vnd.docker.distribution.manifest.v2+json" \
         --header "Authorization: Bearer $(auth)" \
         --location \
         --request HEAD \
         --show-error \
         --silent |
    grep -Pio '(?<=Docker-Content-Digest: )sha256:\w+'
}

[ "$#" -ne 3 ] && echo "usage: ./docker-content-digest <docker|qwant> <image> <tag>" && exit 1

service="$1"

if [ "$service" == "qwant" ]; then
    registry_url="$CI_REGISTRY"
    auth_service="https://git.qwant.ninja/jwt/auth?service=container_registry"
elif [ "$service" == "docker" ]; then
    registry_url="registry-1.docker.io"
    auth_service="https://auth.docker.io/token?service=registry.docker.io"
else
    echo "first argument must be 'qwant' OR 'docker'"
    exit 1
fi

digest "$2" "$3"
